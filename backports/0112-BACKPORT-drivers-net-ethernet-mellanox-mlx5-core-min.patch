From: Talat Batheesh <talatb@mellanox.com>
Subject: [PATCH] BACKPORT: drivers/net/ethernet/mellanox/mlx5/core/miniflow.c

Change-Id: Iec18e297e96ee83d4a7db4c65f0efa8d4589510f
---
 drivers/net/ethernet/mellanox/mlx5/core/miniflow.c | 9 +++++++--
 1 file changed, 7 insertions(+), 2 deletions(-)

diff --git a/drivers/net/ethernet/mellanox/mlx5/core/miniflow.c b/drivers/net/ethernet/mellanox/mlx5/core/miniflow.c
index xxxxxxx..xxxxxxx 100644
--- a/drivers/net/ethernet/mellanox/mlx5/core/miniflow.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/miniflow.c
@@ -741,7 +741,11 @@ static int miniflow_add_fdb_flow(struct mlx5e_priv *priv,
 {
 	int err;
 
-	err = mlx5e_tc_add_fdb_flow(priv, mflow, NULL);
+	err = mlx5e_tc_add_fdb_flow(priv, mflow
+#ifdef HAVE_TC_CLS_OFFLOAD_EXTACK
+		,NULL
+#endif
+	);
 	complete_all(&mflow->init_done);
 	if (err) {
 		inc_debug_counter(&nr_of_total_mf_err_fdb_add);
@@ -758,7 +762,7 @@ static int miniflow_alloc_flow(struct mlx5e_miniflow *miniflow,
 			       struct mlx5e_tc_flow **out_flow,
 			       struct mlx5_fc **dummy_counters)
 {
-	u32 flags = MLX5E_TC_FLOW_SIMPLE | MLX5E_TC_FLOW_ESWITCH;
+	u32 flags = MLX5E_TC_FLOW_SIMPLE | MLX5E_TC_FLOW_FLAG_ESWITCH;
 	u32 tmp_mask[MLX5_ST_SZ_DW(fte_match_param)];
 	struct mlx5_eswitch *esw = priv->mdev->priv.eswitch;
 	struct mlx5e_tc_flow_parse_attr *mparse_attr;
@@ -1081,6 +1085,7 @@ static int miniflow_cache_get(void)
 	if (!miniflow_cache)
 		return -ENOMEM;
 
+#define __WQ_LEGACY (1 << 18)
 	miniflow_wq = alloc_workqueue("miniflow",
 				      __WQ_LEGACY | WQ_MEM_RECLAIM |
 				      WQ_UNBOUND | WQ_HIGHPRI | WQ_SYSFS, 16);
